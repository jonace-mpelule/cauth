import e,{randomInt as t}from"node:crypto";import n from"argon2";var r=Object.create,i=Object.defineProperty,a=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,s=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,l=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),u=(e,t,n,r)=>{if(t&&typeof t==`object`||typeof t==`function`)for(var s=o(t),l=0,u=s.length,d;l<u;l++)d=s[l],!c.call(e,d)&&d!==n&&i(e,d,{get:(e=>t[e]).bind(null,d),enumerable:!(r=a(t,d))||r.enumerable});return e},d=((e,t,n)=>(n=e==null?{}:r(s(e)),u(t||!e||!e.__esModule?i(n,`default`,{value:e,enumerable:!0}):n,e)))(l(((e,t)=>{var n=1e3,r=n*60,i=r*60,a=i*24,o=a*7,s=a*365.25;t.exports=function(e,t){t||={};var n=typeof e;if(n===`string`&&e.length>0)return c(e);if(n===`number`&&isFinite(e))return t.long?u(e):l(e);throw Error(`val is not a non-empty string or a valid number. val=`+JSON.stringify(e))};function c(e){if(e=String(e),!(e.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var c=parseFloat(t[1]);switch((t[2]||`ms`).toLowerCase()){case`years`:case`year`:case`yrs`:case`yr`:case`y`:return c*s;case`weeks`:case`week`:case`w`:return c*o;case`days`:case`day`:case`d`:return c*a;case`hours`:case`hour`:case`hrs`:case`hr`:case`h`:return c*i;case`minutes`:case`minute`:case`mins`:case`min`:case`m`:return c*r;case`seconds`:case`second`:case`secs`:case`sec`:case`s`:return c*n;case`milliseconds`:case`millisecond`:case`msecs`:case`msec`:case`ms`:return c;default:return}}}}function l(e){var t=Math.abs(e);return t>=a?Math.round(e/a)+`d`:t>=i?Math.round(e/i)+`h`:t>=r?Math.round(e/r)+`m`:t>=n?Math.round(e/n)+`s`:e+`ms`}function u(e){var t=Math.abs(e);return t>=a?d(e,t,a,`day`):t>=i?d(e,t,i,`hour`):t>=r?d(e,t,r,`minute`):t>=n?d(e,t,n,`second`):e+` ms`}function d(e,t,n,r){var i=t>=n*1.5;return Math.round(e/n)+` `+r+(i?`s`:``)}}))(),1);function f({token:t,refreshTokenSecret:n}){return e.createHmac(`sha256`,n).update(t).digest(`hex`)}function p({incomingToken:t,storedHash:n,refreshTokenSecret:r}){let i=f({token:t,refreshTokenSecret:r});return e.timingSafeEqual(Buffer.from(i),Buffer.from(n))}var m=class{#client;constructor(e){this.#client=e}async createOTP({config:e},{...r}){let i=Math.min(Math.max(e?.otpConfig?.length??6,4),8),a=Array.from({length:i},()=>t(0,10)).join(``),o=e?.otpConfig?.expiresIn??300*1e3,s=new Date(Date.now()+o),c=await n.hash(a,{type:n.argon2id}),l;try{l=await this.#client.otp.update({where:{id:r.id},data:{code:c,isUsed:!1,purpose:r.purpose,expiresAt:s}})}catch(e){e.code===`P2025`&&(l=await this.#client.otp.create({data:{id:r.id,code:c,isUsed:!1,purpose:r.purpose,expiresAt:s}}))}return{code:a,purpose:l.purpose,expiresAt:s}}async verifyOTP({...e}){let t=await this.#client.otp.findFirst({where:{id:e.id}});return!t||!await n.verify(e.code,t.code)||t.isUsed||t.expiresAt.getTime()<Date.now()||t.purpose!==e.purpose?{isValid:!1}:(await this.#client.otp.update({where:{id:t.id},data:{isUsed:!0}}),{isValid:!0})}async findAccountById({id:e}){return await this.#client.auth.findFirst({where:{id:e}})}async findAccountWithCredential({...e}){return await this.#client.auth.findFirst({where:{OR:[{email:e.email},{phoneNumber:e.phoneNumber}]},select:e.select})}async createAccount({...e}){return await this.#client.auth.create({data:e.data})}async removeAndAddRefreshToken({id:e,refreshToken:t,select:n,newRefreshToken:r,config:i}){let a=await this.findAccountById({id:e});if(!a)throw Error(`account-not-found: ${e}`);let o={token:f({token:String(r),refreshTokenSecret:i.jwtConfig.refreshTokenSecret}),exp:(0,d.default)(i.jwtConfig.refreshTokenLifeSpan)},s=a?.refreshTokens?.filter(e=>p({incomingToken:t,storedHash:e.token,refreshTokenSecret:i.jwtConfig.refreshTokenSecret}));return r&&(s?.push(o),s=Array.from(new Set(s))),this.#client.auth.update({where:{id:e},data:{refreshTokens:{set:s}},select:n})}async updateAccountLogin({...e}){let t={token:f({token:e.refreshToken,refreshTokenSecret:e.config.jwtConfig.refreshTokenSecret}),exp:(0,d.default)(e.config.jwtConfig.refreshTokenLifeSpan)};return this.#client.auth.update({where:{id:e.id},data:{lastLogin:new Date,refreshTokens:{push:t}},select:e.select})}async updateAccount({...e}){return await this.#client.auth.update({where:{id:e.id},data:e.data})}async deleteAccount({id:e}){return await this.#client.auth.delete({where:{id:e}})}};export{m as PrismaContractor};
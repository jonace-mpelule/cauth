var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),s=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},c=(n,r,a)=>(a=n==null?{}:e(i(n)),s(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let l=require(`zod`);l=c(l);let u=require(`libphonenumber-js`);u=c(u);let d=require(`jsonwebtoken`);d=c(d);var f=class{static ValidationError=`validation-error`;static CredentialError=`credential-error`;static UnKnownError=`unknown-error`;static InvalidDataError=`invalid-data-error`},p=class{static ServerError=`internal-server-error`;static ServerErrorMessage=`Internal server error. We are working to fix this, please try again later`;static InvalidToken=`invalid-token`;static InvalidTokenMessage=`Invalid Token`;static ForbiddenResource=`forbidden-resource`;static ForbiddenResourceMessage=`You don't have sufficient permission for this action`;static InvalidOtp=`invalid-otp`;static InvalidOtpMessage=`Invalid Otp. Please check and try again`;static CredentialMismatch=`credential-mismatch`;static CredentialMismatchMessage=`Credential mismatch. Please check your credentials and try again.`;static InvalidData=`invalid-data`;static InvalidDataMessage=e=>`Invalid Body: ${e}`;static AccountNotFound=`account-not-found`;static AccountNotFoundMessage=`Account not found`;static InvalidRole=`invalid-role`;static InvalidRoleMessage=e=>`Role is invalid, please use one of the following roles: ${e.join(`, `)}`;static InvalidRefreshToken=`invalid-refresh-token`;static InvalidRefreshTokenMessage=`Invalid refresh token`;static DuplicateAccount=`account-already-exists`;static DuplicateAccountMessage=`Account with this credentials already exists`},m=class extends Error{code;static type=f.CredentialError;constructor(){super(p.CredentialMismatchMessage),this.code=p.CredentialMismatch,this.name=`CredentialMismatch`}},h=class extends Error{code;static type=f.ValidationError;constructor(e){super(p.InvalidDataMessage(e)),this.code=p.InvalidData,this.name=`InvalidDataError`}},g=class extends Error{code;static type=f.InvalidDataError;constructor(){super(p.AccountNotFoundMessage),this.code=p.AccountNotFound,this.name=`AccountNotFoundError`}},_=class extends Error{code;static type=f.ValidationError;constructor(e){super(p.InvalidRoleMessage(e)),this.code=p.InvalidRole,this.name=`InvalidRoleError`}},v=class extends Error{code;static type=f.ValidationError;constructor(){super(p.InvalidRefreshTokenMessage),this.code=p.InvalidRefreshToken,this.name=`InvalidRefreshTokenError`}},y=class extends Error{code;static type=f.ValidationError;constructor(){super(p.DuplicateAccountMessage),this.code=p.DuplicateAccount,this.name=`DuplicateAccountError`}},b=class extends Error{code;static type=f.ValidationError;constructor(){super(p.InvalidOtpMessage),this.code=p.InvalidOtp,this.name=`InvalidOTPCode`}};const x=l.z.string().trim().refine(e=>{let t=(0,u.parsePhoneNumberFromString)(e);return!!t&&t.isValid()},{message:`Invalid phone number`}).transform(e=>(0,u.parsePhoneNumberFromString)(e)?.format(`E.164`)??e),S=l.z.object({email:l.z.email(),phoneNumber:l.z.never(),password:l.z.string()}),C=l.z.object({phoneNumber:x,email:l.z.never().optional(),password:l.z.string()}),w=l.z.union([S,C]).superRefine((e,t)=>{e.email&&e.phoneNumber&&t.addIssue({code:l.z.ZodIssueCode.custom,message:`Provide either email or phoneNumber`,path:[`email`,`phoneNumber`]})}),T=l.z.object({phoneNumber:x.optional(),email:l.z.email().optional(),role:l.z.string(),password:l.z.string()}),E=T.superRefine((e,t)=>{!e.email&&!e.phoneNumber&&t.addIssue({code:l.z.ZodIssueCode.custom,message:`Provide either email or phoneNumber`,path:[`email`,`phoneNumber`]})}),D=l.z.object({refreshToken:l.z.jwt({message:`refreshToken: should be a valid jwt string`})}),O=l.z.object({refreshToken:l.z.jwt()}),k=l.z.object({accountId:l.z.string(),oldPassword:l.z.string(),newPassword:l.z.string()});function A(e){return`${e?.error?.issues[0].path}: ${e?.error?.issues[0].message}`}var j=o(((e,t)=>{var n=require(`fs`),r=require(`path`),i=require(`os`),a=typeof __webpack_require__==`function`?__non_webpack_require__:require,o=process.config&&process.config.variables||{},s=!!process.env.PREBUILDS_ONLY,c=process.versions.modules,l=D()?`electron`:E()?`node-webkit`:`node`,u=process.env.npm_config_arch||i.arch(),d=process.env.npm_config_platform||i.platform(),f=process.env.LIBC||(O(d)?`musl`:`glibc`),p=process.env.ARM_VERSION||(u===`arm64`?`8`:o.arm_version)||``,m=(process.versions.uv||``).split(`.`)[0];t.exports=h;function h(e){return a(h.resolve(e))}h.resolve=h.path=function(e){e=r.resolve(e||`.`);try{var t=a(r.join(e,`package.json`)).name.toUpperCase().replace(/-/g,`_`);process.env[t+`_PREBUILD`]&&(e=process.env[t+`_PREBUILD`])}catch{}if(!s){var n=_(r.join(e,`build/Release`),v);if(n)return n;var i=_(r.join(e,`build/Debug`),v);if(i)return i}var o=E(e);if(o)return o;var h=E(r.dirname(process.execPath));if(h)return h;var w=[`platform=`+d,`arch=`+u,`runtime=`+l,`abi=`+c,`uv=`+m,p?`armv=`+p:``,`libc=`+f,`node=`+process.versions.node,process.versions.electron?`electron=`+process.versions.electron:``,typeof __webpack_require__==`function`?`webpack=true`:``].filter(Boolean).join(` `);throw Error(`No native build was found for `+w+`
    loaded from: `+e+`
`);function E(e){var t=g(r.join(e,`prebuilds`)).map(y).filter(b(d,u)).sort(x)[0];if(t){var n=r.join(e,`prebuilds`,t.name),i=g(n).map(S).filter(C(l,c)).sort(T(l))[0];if(i)return r.join(n,i.file)}}};function g(e){try{return n.readdirSync(e)}catch{return[]}}function _(e,t){var n=g(e).filter(t);return n[0]&&r.join(e,n[0])}function v(e){return/\.node$/.test(e)}function y(e){var t=e.split(`-`);if(t.length===2){var n=t[0],r=t[1].split(`+`);if(n&&r.length&&r.every(Boolean))return{name:e,platform:n,architectures:r}}}function b(e,t){return function(n){return n==null||n.platform!==e?!1:n.architectures.includes(t)}}function x(e,t){return e.architectures.length-t.architectures.length}function S(e){var t=e.split(`.`),n=t.pop(),r={file:e,specificity:0};if(n===`node`){for(var i=0;i<t.length;i++){var a=t[i];if(a===`node`||a===`electron`||a===`node-webkit`)r.runtime=a;else if(a===`napi`)r.napi=!0;else if(a.slice(0,3)===`abi`)r.abi=a.slice(3);else if(a.slice(0,2)===`uv`)r.uv=a.slice(2);else if(a.slice(0,4)===`armv`)r.armv=a.slice(4);else if(a===`glibc`||a===`musl`)r.libc=a;else continue;r.specificity++}return r}}function C(e,t){return function(n){return!(n==null||n.runtime&&n.runtime!==e&&!w(n)||n.abi&&n.abi!==t&&!n.napi||n.uv&&n.uv!==m||n.armv&&n.armv!==p||n.libc&&n.libc!==f)}}function w(e){return e.runtime===`node`&&e.napi}function T(e){return function(t,n){return t.runtime===n.runtime?t.abi===n.abi?t.specificity===n.specificity?0:t.specificity>n.specificity?-1:1:t.abi?-1:1:t.runtime===e?-1:1}}function E(){return!!(process.versions&&process.versions.nw)}function D(){return process.versions&&process.versions.electron||process.env.ELECTRON_RUN_AS_NODE?!0:typeof window<`u`&&window.process&&window.process.type===`renderer`}function O(e){return e===`linux`&&n.existsSync(`/etc/alpine-release`)}h.parseTags=S,h.matchTags=C,h.compareTags=T,h.parseTuple=y,h.matchTuple=b,h.compareTuples=x})),M=o(((e,t)=>{let n=typeof __webpack_require__==`function`?__non_webpack_require__:require;typeof n.addon==`function`?t.exports=n.addon.bind(n):t.exports=j()})),N=o(((e,t)=>{let n=global.Promise;function r(e,t,r){return Array.isArray(r)||(r=Array.prototype.slice.call(r)),typeof e==`function`?new n((n,i)=>{r.push((e,t)=>{e?i(e):n(t)}),e.apply(t,r)}):n.reject(Error(`fn must be a function`))}function i(e){return n.reject(e)}function a(e){n=e}t.exports={promise:r,reject:i,use:a}})),P=o(((e,t)=>{let n=require(`path`),r=M()(n.resolve(__dirname)),i=require(`crypto`),a=N();function o(e,t){if(!e)e=10;else if(typeof e!=`number`)throw Error(`rounds must be a number`);if(!t)t=`b`;else if(t!==`b`&&t!==`a`)throw Error(`minor must be either "a" or "b"`);return r.gen_salt_sync(t,e,i.randomBytes(16))}function s(e,t,n){let o;if(typeof arguments[0]==`function`?(n=arguments[0],e=10,t=`b`):typeof arguments[1]==`function`&&(n=arguments[1],t=`b`),!n)return a.promise(s,this,[e,t]);if(!e)e=10;else if(typeof e!=`number`)return o=Error(`rounds must be a number`),process.nextTick(function(){n(o)});if(!t)t=`b`;else if(t!==`b`&&t!==`a`)return o=Error(`minor must be either "a" or "b"`),process.nextTick(function(){n(o)});i.randomBytes(16,function(i,a){if(i){n(i);return}r.gen_salt(t,e,a,n)})}function c(e,n){if(e==null||n==null)throw Error(`data and salt arguments required`);if(!(typeof e==`string`||e instanceof Buffer)||typeof n!=`string`&&typeof n!=`number`)throw Error(`data must be a string or Buffer and salt must either be a salt string or a number of rounds`);return typeof n==`number`&&(n=t.exports.genSaltSync(n)),r.encrypt_sync(e,n)}function l(e,n,i){let o;return typeof e==`function`?(o=Error(`data must be a string or Buffer and salt must either be a salt string or a number of rounds`),process.nextTick(function(){e(o)})):typeof n==`function`?(o=Error(`data must be a string or Buffer and salt must either be a salt string or a number of rounds`),process.nextTick(function(){n(o)})):i&&typeof i!=`function`?a.reject(Error(`cb must be a function or null to return a Promise`)):i?e==null||n==null?(o=Error(`data and salt arguments required`),process.nextTick(function(){i(o)})):!(typeof e==`string`||e instanceof Buffer)||typeof n!=`string`&&typeof n!=`number`?(o=Error(`data must be a string or Buffer and salt must either be a salt string or a number of rounds`),process.nextTick(function(){i(o)})):typeof n==`number`?t.exports.genSalt(n,function(t,n){return r.encrypt(e,n,i)}):r.encrypt(e,n,i):a.promise(l,this,[e,n])}function u(e,t){if(e==null||t==null)throw Error(`data and hash arguments required`);if(!(typeof e==`string`||e instanceof Buffer)||typeof t!=`string`)throw Error(`data must be a string or Buffer and hash must be a string`);return r.compare_sync(e,t)}function d(e,t,n){let i;return typeof e==`function`?(i=Error(`data and hash arguments required`),process.nextTick(function(){e(i)})):typeof t==`function`?(i=Error(`data and hash arguments required`),process.nextTick(function(){t(i)})):n&&typeof n!=`function`?a.reject(Error(`cb must be a function or null to return a Promise`)):n?e==null||t==null?(i=Error(`data and hash arguments required`),process.nextTick(function(){n(i)})):!(typeof e==`string`||e instanceof Buffer)||typeof t!=`string`?(i=Error(`data and hash must be strings`),process.nextTick(function(){n(i)})):r.compare(e,t,n):a.promise(d,this,[e,t])}function f(e){if(e==null)throw Error(`hash argument required`);if(typeof e!=`string`)throw Error(`hash must be a string`);return r.get_rounds(e)}t.exports={genSaltSync:o,genSalt:s,hashSync:c,hash:l,compareSync:u,compare:d,getRounds:f}})),F=c(P(),1);function I(e){return{success:!0,value:e}}function L(...e){return{success:!1,errors:e}}async function R({config:e},{...t}){let n=k.safeParse(t);if(!n.success)return L({type:h.type,error:new h(A(n))});let r=await e.dbContractor.findAccountById({id:t.accountId});if(!r)return L({type:g.type,error:new g});if(!F.default.compare(t.oldPassword,String(r.passwordHash)))return L({type:m.type,error:new m});let i=await F.default.hash(t.newPassword,10);return await e.dbContractor.updateAccount({id:r.id,data:{passwordHash:i}}),I({})}var z=c(P(),1);async function B({config:e,tokens:t},{...n}){let r=w.safeParse(n);if(!r.success)return L({type:h.type,error:new h(A(r))});let i=await e.dbContractor.findAccountWithCredential({email:n.email,phoneNumber:n.phoneNumber});if(!i||!await z.default.compare(String(n.password),String(i?.passwordHash)))return L({type:m.type,error:new m});let a=await t.GenerateTokenPairs({id:i.id,role:i.role});return await e.dbContractor.updateAccountLogin({id:i.id,refreshToken:a.refreshToken}),delete i.passwordHash,delete i.refreshTokens,I({account:i,tokens:a})}async function V(e){try{return{data:await e,error:null}}catch(e){return{data:null,error:e}}}async function H({config:e,tokens:t},{...n}){let r=O.safeParse(n);if(!r.success)return L({type:h.type,error:new h(A(r))});let i=await V(t.VerifyRefreshToken(n.refreshToken));return i.error||!i?L({type:v.type,error:new v}):(await e.dbContractor.removeAndAddRefreshToken({id:String(i.data?.id),refreshToken:n.refreshToken}),I({}))}async function U({config:e,tokens:t},{...n}){let r=D.safeParse(n);if(!r.success)return L({type:h.type,error:new h(A(r))});let i=await V(t.VerifyRefreshToken(n.refreshToken));if(i.error)return L({type:v.type,error:new v});let a=await e.dbContractor.findAccountById({id:String(i.data?.id)});if(!a)return L({type:g.type,error:new g});if(!a?.refreshTokens?.includes(n.refreshToken))return L({type:v.type,error:new v});let o=await t.GenerateTokenPairs({id:a.id,role:a.role});return await e.dbContractor.updateAccountLogin({id:a.id,refreshToken:o.refreshToken}),delete a.refreshTokens,delete a.passwordHash,I({account:a,tokens:o})}var W=c(P(),1);async function G({config:e,tokens:t},{...n}){let r=E.safeParse(n);if(!r.success)return L({type:h.type,error:new h(A(r))});if(!e.roles?.includes(n.role))return L({type:_.type,error:new _(e.roles)});if(await e.dbContractor.findAccountWithCredential({email:n.email,phoneNumber:n.phoneNumber}))return L({type:y.type,error:new y});let i=await W.default.hash(n.password,10),a=await e.dbContractor.createAccount({data:{email:n.email,phoneNumber:n.phoneNumber,passwordHash:i,role:n.role,lastLogin:new Date}}),o=await t.GenerateTokenPairs({id:a.id,role:a.role});return await e.dbContractor.updateAccountLogin({id:a.id,refreshToken:o.refreshToken}),I({account:a,tokens:o})}async function K({...e}){return d.default.sign(e.payload,e.config.accessTokenSecret,{expiresIn:e.config.jwtConfig?.accessTokenLifeSpan??`15m`})}async function q({...e}){return d.default.sign(e.payload,e.config.refreshTokenSecret,{expiresIn:e.config.jwtConfig?.refreshTokenLifeSpan??`30d`})}async function J({...e}){return{accessToken:d.default.sign(e.payload,e.config.accessTokenSecret,{expiresIn:e.config.jwtConfig?.accessTokenLifeSpan??`15m`}),refreshToken:d.default.sign(e.payload,e.config.refreshTokenSecret,{expiresIn:e.config.jwtConfig?.refreshTokenLifeSpan??`30d`})}}async function Y({...e}){let t=d.default.verify(e.token,e.config.refreshTokenSecret);return t instanceof String?null:t}async function X({...e}){let t=d.default.verify(e.token,e.config.accessTokenSecret);return t instanceof String?null:t}const ee=l.default.custom(()=>!0,{message:`Invalid dbContractor: must implement Database Contract interface`}),te=l.default.custom(()=>!0,{message:`Invalid routeContractor: must implement RoutesContract interface`}),Z=l.default.custom(),Q=l.default.object({dbContractor:ee,routeContractor:te,refreshTokenSecret:l.default.string(),accessTokenSecret:l.default.string(),roles:l.default.array(l.default.string()).min(1),jwtConfig:l.default.object({accessTokenLifeSpan:Z.optional(),refreshTokenLifeSpan:Z.optional()}).optional(),otpConfig:l.default.object({expiresIn:l.default.number().optional(),length:l.default.number().min(4).max(8).optional()})});var ne=class{#config;constructor(e){if(!Q.safeParse(e).success)throw Error(`❌ Failed to initiate CAuth. You provided an invalid config!`);this.#config=e}get RoleType(){return null}Guard=e=>this.#config.routeContractor.Guard({config:this.#config,tokens:this.Tokens,roles:e});Routes={Register:()=>this.#config.routeContractor.Register({config:this.#config,tokens:this.Tokens}),Login:()=>this.#config.routeContractor.Login({config:this.#config,tokens:this.Tokens}),Logout:()=>this.#config.routeContractor.Logout({config:this.#config,tokens:this.Tokens}),Refresh:()=>this.#config.routeContractor.Refresh({config:this.#config,tokens:this.Tokens}),ChangePassword:e=>this.#config.routeContractor.ChangePassword({config:this.#config,tokens:this.Tokens,userId:e})};FN={Login:({...e})=>B({config:this.#config,tokens:this.Tokens},e),Register:({...e})=>G({config:this.#config,tokens:this.Tokens},e),Logout:({...e})=>H({config:this.#config,tokens:this.Tokens},e),Refresh:({...e})=>U({config:this.#config,tokens:this.Tokens},e),ChangePassword:({...e})=>R({config:this.#config,tokens:this.Tokens},e)};Tokens={GenerateRefreshToken:e=>q({payload:e,config:this.#config}),GenerateAccessToken:e=>K({payload:e,config:this.#config}),GenerateTokenPairs:e=>J({payload:e,config:this.#config}),VerifyRefreshToken:e=>Y({token:e,config:this.#config}),VerifyAccessToken:e=>X({token:e,config:this.#config})}};function re(e){return new ne(e)}const $=l.default.object({id:l.default.string(),phoneNumber:l.default.string(),email:l.default.string(),passwordHash:l.default.string().optional(),role:l.default.string(),lastLogin:l.default.date(),refreshTokens:l.default.string().array().optional(),createdAt:l.default.date(),updatedAt:l.default.date()}),ie={id:!0,phoneNumber:!0,email:!0,passwordHash:!1,role:!0,lastLogin:!0,refreshTokens:!1,createdAt:!0,updatedAt:!0},ae=l.default.object({id:l.default.string(),auth:$.optional(),code:l.default.string(),purpose:l.default.string(),expiresAt:l.default.date(),createdAt:l.default.date(),updatedAt:l.default.date()});exports.AccountNotFoundError=g,exports.AuthModelSchema=$,exports.AuthModelSelect=ie,exports.CAuth=re,exports.CAuthOptionsSchema=Q,exports.CredentialMismatchError=m,exports.DuplicateAccountError=y,exports.InvalidDataError=h,exports.InvalidOTPCode=b,exports.InvalidRefreshTokenError=v,exports.InvalidRoleError=_,exports.OtpSchema=ae;
import e,{z as t}from"zod";import{parsePhoneNumberFromString as n}from"libphonenumber-js";import r from"jsonwebtoken";var i=class{static LoginPurpose=`LOGIN`;static ResetPasswordPurpose=`RESET_PASSWORD`;static ActionPurpose=`ACTION`};const a=t.string().trim().refine(e=>{let t=n(e);return!!t&&t.isValid()},{message:`Invalid phone number`}).transform(e=>n(e)?.format(`E.164`)??e),o=t.enum([`LOGIN`,`RESET_PASSWORD`,`ACTION`]),s=t.object({email:t.email(),phoneNumber:t.never().optional(),password:t.string().min(6).optional()}),c=t.object({phoneNumber:a,email:t.never().optional(),password:t.string().min(6).optional()}),l=t.union([s,c]).superRefine((e,n)=>{e.email&&e.phoneNumber&&n.addIssue({code:t.ZodIssueCode.custom,message:`Provide either email or phoneNumber`,path:[`email`,`phoneNumber`]})}),u=t.object({phoneNumber:a,email:t.never().optional(),code:t.string().min(4).max(8)}),d=t.object({email:t.email(),phoneNumber:t.never().optional(),code:t.string().min(4).max(8)}),f=t.union([d,u]),p=t.object({otpPurpose:o,usePassword:t.boolean().default(!1),password:t.string().optional()}),m=p.extend({phoneNumber:a,email:t.never().optional()}),h=p.extend({phoneNumber:t.never().optional(),email:t.string().email()});t.union([m,h]).refine(e=>e.usePassword?!!e.password:!e.password,{message:`Password required only if usePassword is true`,path:[`password`]});const g=t.object({phoneNumber:a.optional(),email:t.email().optional(),role:t.string(),password:t.string().optional()}).superRefine((e,n)=>{!e.email&&!e.phoneNumber&&n.addIssue({code:t.ZodIssueCode.custom,message:`Provide either email or phoneNumber`,path:[`email`,`phoneNumber`]})}),_=t.object({refreshToken:t.string()}),v=t.object({refreshToken:t.string()}),y=t.object({accountId:t.string(),oldPassword:t.string(),newPassword:t.string()});var b=class{static ValidationError=`validation-error`;static CredentialError=`credential-error`;static UnKnownError=`unknown-error`;static InvalidDataError=`invalid-data-error`},x=class{static ServerError=`internal-server-error`;static ServerErrorMessage=`Internal server error. We are working to fix this, please try again later`;static InvalidToken=`invalid-token`;static InvalidTokenMessage=`Invalid Token`;static ForbiddenResource=`forbidden-resource`;static ForbiddenResourceMessage=`You don't have sufficient permission for this action`;static InvalidOtp=`invalid-otp`;static InvalidOtpMessage=`Invalid Otp. Please check and try again`;static CredentialMismatch=`credential-mismatch`;static CredentialMismatchMessage=`Credential mismatch. Please check your credentials and try again.`;static InvalidData=`invalid-data`;static InvalidDataMessage=e=>`Invalid Body: ${e}`;static AccountNotFound=`account-not-found`;static AccountNotFoundMessage=`Account not found`;static InvalidRole=`invalid-role`;static InvalidRoleMessage=e=>`Role is invalid, please use one of the following roles: ${e.join(`, `)}`;static InvalidRefreshToken=`invalid-refresh-token`;static InvalidRefreshTokenMessage=`Invalid refresh token`;static DuplicateAccount=`account-already-exists`;static DuplicateAccountMessage=`Account with this credentials already exists`;static SchemaValidationError=`schema-validation`;static SchemaValidationMessage=`Your database error is not is sync with CAuth Spec`};const S={CredentialMismatchError:{type:b.CredentialError,message:x.CredentialMismatchMessage,code:x.CredentialMismatch,name:`CredentialMismatchError`},InvalidDataError:e=>({type:b.ValidationError,message:x.InvalidDataMessage(e),code:x.InvalidData,name:`InvalidDataError`}),AccountNotFoundError:{type:b.InvalidDataError,message:x.AccountNotFoundMessage,code:x.AccountNotFound,name:`AccountNotFoundError`},InvalidRoleError:e=>({type:b.ValidationError,message:x.InvalidRoleMessage(e),code:x.InvalidRole,name:`InvalidRoleError`}),InvalidRefreshTokenError:{type:b.ValidationError,message:x.InvalidRefreshTokenMessage,code:x.InvalidRefreshToken,name:`InvalidRefreshTokenError`},DuplicateAccountError:{type:b.ValidationError,message:x.DuplicateAccountMessage,code:x.DuplicateAccount,name:`DuplicateAccountError`},InvalidOTPCode:{type:b.ValidationError,message:x.InvalidOtpMessage,code:x.InvalidOtp,name:`InvalidOTPCode`},SchemaInvalidError:{type:b.ValidationError,message:x.SchemaValidationMessage,code:x.SchemaValidationError,name:`SchemaInvalidError`}};function C(e,t){return typeof e==`object`&&!!e&&`name`in e&&e.name===t}function w(e,t){return C(e,t)}function T(e){return`${e?.error?.issues[0].path}: ${e?.error?.issues[0].message}`}function E(e){return{success:!0,value:e}}function D(...e){return{success:!1,errors:e}}async function O({config:e},{...t}){let n=l.safeParse({email:t.email,phoneNumber:t.phoneNumber});if(!n.success)return D({error:S.InvalidDataError(T(n))});let r=await e.dbContractor.findAccountWithCredential({phoneNumber:t.phoneNumber,email:t.email});return!r||t.usePassword&&!await Bun.password.verify(String(t.password),String(r?.passwordHash))?D({error:S.CredentialMismatchError}):(await e.dbContractor.createOTP({config:e},{id:r.id,purpose:t.otpPurpose}),E({id:r.id}))}async function k({config:e,tokens:t},n){let r=f.safeParse({phoneNumber:n.phoneNumber,email:n.email,code:n.code});if(!r.success)return D({error:S.InvalidDataError(T(r))});let a=await e.dbContractor.findAccountWithCredential({email:n.email,phoneNumber:n.phoneNumber});if(!a)return D({error:S.CredentialMismatchError});if(!(await e.dbContractor.verifyOTP({id:a.id,code:n.code,purpose:i.LoginPurpose})).isValid)return D({error:S.InvalidOTPCode});let o=await t.GenerateTokenPairs({id:a.id,role:a.role});return await e.dbContractor.updateAccountLogin({id:a.id,refreshToken:o.refreshToken}),delete a.passwordHash,delete a.refreshTokens,E({account:a,tokens:o})}async function A({config:e},t){return E({isValid:(await e.dbContractor.verifyOTP({id:t.id,code:t.code,purpose:t.otpPurpose})).isValid})}async function j({config:e},{...t}){let n=y.safeParse(t);if(!n.success)return D({error:S.InvalidDataError(T(n))});let r=await e.dbContractor.findAccountById({id:t.accountId});if(!r||!Bun.password.verify(t.oldPassword,String(r.passwordHash)))return D({error:S.CredentialMismatchError});let i=await Bun.password.hash(t.newPassword,{algorithm:`argon2id`});return await e.dbContractor.updateAccount({id:r.id,data:{passwordHash:i}}),E({})}async function M({config:e,tokens:t},{...n}){let r=l.safeParse(n);if(!r.success)return D({error:S.InvalidDataError(T(r))});let i=await e.dbContractor.findAccountWithCredential({email:n.email,phoneNumber:n.phoneNumber});if(!i||!await Bun.password.verify(String(n.password),String(i?.passwordHash)))return D({error:S.CredentialMismatchError});let a=await t.GenerateTokenPairs({id:i.id,role:i.role});return await e.dbContractor.updateAccountLogin({id:i.id,refreshToken:a.refreshToken}),delete i.passwordHash,delete i.refreshTokens,E({account:i,tokens:a})}async function N(e){try{return{data:await e,error:null}}catch(e){return{data:null,error:e}}}async function P({config:e,tokens:t},{...n}){let r=v.safeParse(n);if(!r.success)return D({error:S.InvalidDataError(T(r))});let i=await N(t.VerifyRefreshToken(n.refreshToken));return i.error||!i?D({error:S.InvalidRefreshTokenError}):(await e.dbContractor.removeAndAddRefreshToken({id:String(i.data?.id),refreshToken:n.refreshToken}),E({}))}async function F({config:e,tokens:t},{...n}){let r=_.safeParse(n);if(!r.success)return D({error:S.InvalidDataError(T(r))});let i=await N(t.VerifyRefreshToken(n.refreshToken));if(i.error)return D({error:S.InvalidRefreshTokenError});let a=await e.dbContractor.findAccountById({id:String(i.data?.id)});if(!a)return D({error:S.AccountNotFoundError});if(!a?.refreshTokens?.includes(n.refreshToken))return D({error:S.InvalidRefreshTokenError});let o=await t.GenerateTokenPairs({id:a.id,role:a.role});return await e.dbContractor.removeAndAddRefreshToken({id:a.id,refreshToken:n.refreshToken,newRefreshToken:o.refreshToken}),delete a.refreshTokens,delete a.passwordHash,E({account:a,tokens:o})}async function I({config:e,tokens:t},{...n}){let r=g.safeParse(n);if(!r.success)return D({error:S.InvalidDataError(T(r))});if(!e.roles?.includes(n.role))return D({error:S.InvalidRoleError(e.roles)});if(await e.dbContractor.findAccountWithCredential({email:n.email,phoneNumber:n.phoneNumber}))return D({error:S.DuplicateAccountError});let i=await Bun.password.hash(String(n.password),{algorithm:`argon2id`}),a=await e.dbContractor.createAccount({data:{email:n.email,phoneNumber:n.phoneNumber,passwordHash:i,role:n.role,lastLogin:new Date}}),o=await t.GenerateTokenPairs({id:a.id,role:a.role});return await e.dbContractor.updateAccountLogin({id:a.id,refreshToken:o.refreshToken}),E({account:a,tokens:o})}async function L({...e}){return r.sign(e.payload,e.config.jwtConfig.accessTokenSecret,{expiresIn:e.config.jwtConfig?.accessTokenLifeSpan??`15m`})}async function R({...e}){return r.sign(e.payload,e.config.jwtConfig.refreshTokenSecret,{expiresIn:e.config.jwtConfig?.refreshTokenLifeSpan??`30d`})}async function z({...e}){return{accessToken:r.sign(e.payload,e.config.jwtConfig.accessTokenSecret,{expiresIn:e.config.jwtConfig?.accessTokenLifeSpan??`15m`}),refreshToken:r.sign(e.payload,e.config.jwtConfig.refreshTokenSecret,{expiresIn:e.config.jwtConfig?.refreshTokenLifeSpan??`30d`})}}async function B({...e}){let t=r.verify(e.token,e.config.jwtConfig.refreshTokenSecret);return t instanceof String?null:t}async function V({...e}){let t=r.verify(e.token,e.config.jwtConfig.accessTokenSecret);return t instanceof String?null:t}const H=e.custom(()=>!0,{message:`Invalid dbContractor: must implement Database Contract interface`}),U=e.custom(()=>!0,{message:`Invalid routeContractor: must implement RoutesContract interface`}),W=e.custom(),G=e.object({dbContractor:H,routeContractor:U,roles:e.array(e.string()).min(1),jwtConfig:e.object({refreshTokenSecret:e.string(),accessTokenSecret:e.string(),accessTokenLifeSpan:W.optional(),refreshTokenLifeSpan:W.optional()}),otpConfig:e.object({expiresIn:e.number().optional(),length:e.number().min(4).max(8).optional()})});var K=class{#config;constructor(e){if(!G.safeParse(e).success)throw Error(`âŒ Failed to initiate CAuth. You provided an invalid config!`);this.#config=e}get RoleType(){return null}Guard=e=>this.#config.routeContractor.Guard({config:this.#config,tokens:this.Tokens,roles:e});Routes={Register:()=>this.#config.routeContractor.Register({config:this.#config,tokens:this.Tokens}),Login:()=>this.#config.routeContractor.Login({config:this.#config,tokens:this.Tokens}),Logout:()=>this.#config.routeContractor.Logout({config:this.#config,tokens:this.Tokens}),Refresh:()=>this.#config.routeContractor.Refresh({config:this.#config,tokens:this.Tokens}),ChangePassword:e=>this.#config.routeContractor.ChangePassword({config:this.#config,tokens:this.Tokens,userId:e})};FN={Login:({...e})=>M({config:this.#config,tokens:this.Tokens},e),Register:({...e})=>I({config:this.#config,tokens:this.Tokens},e),Logout:({...e})=>P({config:this.#config,tokens:this.Tokens},e),Refresh:({...e})=>F({config:this.#config,tokens:this.Tokens},e),ChangePassword:({...e})=>j({config:this.#config,tokens:this.Tokens},e),RequestOTPCode:({...e})=>O({config:this.#config,tokens:this.Tokens},e),LoginWithOTP:e=>k({config:this.#config,tokens:this.Tokens},e),VerifyOTP:e=>A({config:this.#config,tokens:this.Tokens},e)};Tokens={GenerateRefreshToken:e=>R({payload:e,config:this.#config}),GenerateAccessToken:e=>L({payload:e,config:this.#config}),GenerateTokenPairs:e=>z({payload:e,config:this.#config}),VerifyRefreshToken:e=>B({token:e,config:this.#config}),VerifyAccessToken:e=>V({token:e,config:this.#config})}};function q(e){return new K(e)}export{q as CAuth,S as CAuthErrors,w as is,C as isCAuthError};